name: Validate Values Changes

on:
  pull_request:
    paths:
      - "app/**/values.yaml"

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dyff 1.7.1 (strict)
        run: |
          echo "Downloading dyff 1.7.1..."
          wget -O dyff.tar.gz https://github.com/homeport/dyff/releases/download/v1.7.1/dyff_1.7.1_linux_amd64.tar.gz

          echo "Extracting..."
          tar -xzvf dyff.tar.gz

          # 바이너리가 맞는지 확인
          if [ ! -f dyff ]; then
            echo "ERROR: dyff binary not found after extraction."
            exit 1
          fi

          chmod +x dyff
          sudo mv dyff /usr/local/bin/

          echo "dyff version:"
          dyff version

          # version 검증 (정말 1.7.1인지 체크)
          if ! dyff version | grep -q "1.7.1"; then
            echo "ERROR: dyff is NOT version 1.7.1. Aborting."
            exit 1
          fi

      - name: Detect changed values files
        id: changes
        uses: tj-actions/changed-files@v42
        with:
          files: |
            app/**/values.yaml

      - name: Exit early if no values.yaml changed
        if: steps.changes.outputs.any_changed != 'true'
        run: echo "No values.yaml changed. Skipping validation."

      - name: Validate each modified values.yaml
        if: steps.changes.outputs.any_changed == 'true'
        run: |
          FAILED=0

          echo "Changed values.yaml files:"
          echo "${{ steps.changes.outputs.all_changed_files }}"

          for file in ${{ steps.changes.outputs.all_changed_files }}; do
            echo "Checking file: $file"

            git show origin/${{ github.base_ref }}:"$file" > before.yaml 2>/dev/null || touch before.yaml
            git show ${{ github.sha }}:"$file" > after.yaml

            # dyff 1.7.1: change-set + raw → perfect
            dyff between before.yaml after.yaml \
              --omit-header --change-set --output raw \
              | awk '{print $1}' > changed_paths.txt || true

            echo "Changed YAML paths:"
            cat changed_paths.txt || echo "(none)"

            ONLY_ALLOWED=$(grep -E '^(config|secrets)(\.|\[|$)' changed_paths.txt || true)
            DISALLOWED=$(grep -vE '^(config|secrets)(\.|\[|$)' changed_paths.txt || true)

            if [[ -n "$ONLY_ALLOWED" && -n "$DISALLOWED" ]]; then
              echo "❌ ERROR: $file has BOTH secret/config changes AND other rollout changes."
              FAILED=1
            fi
          done

          if [[ "$FAILED" -eq 1 ]]; then
            echo "❌ Validation failed."
            exit 1
          fi

          echo "✅ Validation passed."
