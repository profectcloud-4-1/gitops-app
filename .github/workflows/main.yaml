name: Validate Values Changes

on:
  pull_request:
    paths:
      - "app/**/values.yaml"

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dyff 1.7.1
        run: |
          echo "Downloading dyff 1.7.1..."
          wget -O dyff.tar.gz https://github.com/homeport/dyff/releases/download/v1.7.1/dyff_1.7.1_linux_amd64.tar.gz
          echo "Extracting..."
          tar -xzvf dyff.tar.gz
          if [ ! -f dyff ]; then
            echo "ERROR: dyff binary not found after extraction."
            exit 1
          fi
          chmod +x dyff
          sudo mv dyff /usr/local/bin/
          echo "dyff version:"
          dyff version
          if ! dyff version | grep -q "1.7.1"; then
            echo "ERROR: dyff is NOT version 1.7.1. Aborting."
            exit 1
          fi

      - name: Detect changed values files
        id: changes
        uses: tj-actions/changed-files@v42
        with:
          files: |
            app/**/values.yaml

      - name: Exit early if no values.yaml changed
        if: steps.changes.outputs.any_changed != 'true'
        run: echo "No values.yaml changed. Skipping validation."

      - name: Validate each modified values.yaml
        if: steps.changes.outputs.any_changed == 'true'
        run: |
          FAILED=0
          echo "Changed values.yaml files:"
          echo "${{ steps.changes.outputs.all_changed_files }}"

          for file in ${{ steps.changes.outputs.all_changed_files }}; do
            echo "=========================================="
            echo "Checking file: $file"
            echo "=========================================="
            
            # ì´ì „ ë²„ì „ê³¼ í˜„ì¬ ë²„ì „ ê°€ì ¸ì˜¤ê¸°
            git show origin/${{ github.base_ref }}:"$file" > before.yaml 2>/dev/null || touch before.yaml
            git show ${{ github.sha }}:"$file" > after.yaml
            
            # dyff ì¶œë ¥
            echo "--- dyff output ---"
            dyff between before.yaml after.yaml --omit-header > dyff_output.txt || true
            cat dyff_output.txt
            echo "--- end dyff output ---"
            
            # dyff ì¶œë ¥ì—ì„œ YAML ê²½ë¡œ ì¶”ì¶œ
            # dyff í˜•ì‹: 
            # image.tag
            #   Â± value change
            # secrets.data
            #   + one list entry added:
            
            # ì²« ë²ˆì§¸ ì»¬ëŸ¼ì— ìˆëŠ” ê²½ë¡œë“¤ë§Œ ì¶”ì¶œ (ë“¤ì—¬ì“°ê¸° ì—†ëŠ” ì¤„)
            grep -E '^[a-zA-Z_]' dyff_output.txt > changed_paths.txt || touch changed_paths.txt
            
            echo "--- Extracted paths ---"
            cat changed_paths.txt
            echo "--- End paths ---"
            
            # ê²½ë¡œê°€ ì—†ìœ¼ë©´ ë³€ê²½ì‚¬í•­ ì—†ìŒ
            if [ ! -s changed_paths.txt ]; then
              echo "âš ï¸  No changes detected for $file"
              continue
            fi
            
            # config ë˜ëŠ” secretsë¡œ ì‹œì‘í•˜ëŠ” ê²½ë¡œ ì²´í¬
            CONFIG_SECRET_CHANGES=$(grep -E '^(config|secrets)(\.|$)' changed_paths.txt || true)
            OTHER_CHANGES=$(grep -vE '^(config|secrets)(\.|$)' changed_paths.txt || true)
            
            echo ""
            echo "ğŸ“‹ Analysis:"
            if [[ -n "$CONFIG_SECRET_CHANGES" ]]; then
              echo "âœ“ Config/Secrets changes found:"
              echo "$CONFIG_SECRET_CHANGES" | sed 's/^/  - /'
            fi
            if [[ -n "$OTHER_CHANGES" ]]; then
              echo "âœ“ Other changes found:"
              echo "$OTHER_CHANGES" | sed 's/^/  - /'
            fi
            echo ""
            
            # ê²€ì¦ ë¡œì§: config/secretsì™€ ë‹¤ë¥¸ ë³€ê²½ì´ ë™ì‹œì— ìˆìœ¼ë©´ FAIL
            if [[ -n "$CONFIG_SECRET_CHANGES" && -n "$OTHER_CHANGES" ]]; then
              echo "âŒ ERROR: $file contains BOTH config/secrets changes AND other changes."
              echo ""
              echo "This PR mixes configuration updates with deployment updates."
              echo "Please separate them into different PRs:"
              echo "  - One PR for config/secrets changes only"
              echo "  - Another PR for deployment changes (image tags, replicas, etc.)"
              echo ""
              FAILED=1
            elif [[ -n "$CONFIG_SECRET_CHANGES" && -z "$OTHER_CHANGES" ]]; then
              echo "âœ… OK: Only config/secrets changes (no deployment changes)"
            elif [[ -z "$CONFIG_SECRET_CHANGES" && -n "$OTHER_CHANGES" ]]; then
              echo "âœ… OK: Only deployment changes (no config/secrets)"
            fi
            
            echo ""
          done

          if [[ "$FAILED" -eq 1 ]]; then
            echo "=========================================="
            echo "âŒ Validation FAILED"
            echo "=========================================="
            exit 1
          fi

          echo "=========================================="
          echo "âœ… All validations PASSED"
          echo "=========================================="
