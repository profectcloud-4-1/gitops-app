name: Validate Values Changes

on:
  pull_request:
    paths:
      - "app/**/values.yaml"

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dyff 1.7.1 (strict)
        run: |
          echo "Downloading dyff 1.7.1..."
          wget -O dyff.tar.gz https://github.com/homeport/dyff/releases/download/v1.7.1/dyff_1.7.1_linux_amd64.tar.gz
          echo "Extracting..."
          tar -xzvf dyff.tar.gz
          # 바이너리가 맞는지 확인
          if [ ! -f dyff ]; then
            echo "ERROR: dyff binary not found after extraction."
            exit 1
          fi
          chmod +x dyff
          sudo mv dyff /usr/local/bin/
          echo "dyff version:"
          dyff version
          # version 검증 (정말 1.7.1인지 체크)
          if ! dyff version | grep -q "1.7.1"; then
            echo "ERROR: dyff is NOT version 1.7.1. Aborting."
            exit 1
          fi

      - name: Detect changed values files
        id: changes
        uses: tj-actions/changed-files@v42
        with:
          files: |
            app/**/values.yaml

      - name: Exit early if no values.yaml changed
        if: steps.changes.outputs.any_changed != 'true'
        run: echo "No values.yaml changed. Skipping validation."

      - name: Validate each modified values.yaml
        if: steps.changes.outputs.any_changed == 'true'
        run: |
          FAILED=0
          echo "Changed values.yaml files:"
          echo "${{ steps.changes.outputs.all_changed_files }}"

          for file in ${{ steps.changes.outputs.all_changed_files }}; do
            echo "=========================================="
            echo "Checking file: $file"
            echo "=========================================="
            
            # 이전 버전 파일 가져오기
            git show origin/${{ github.base_ref }}:"$file" > before.yaml 2>/dev/null || touch before.yaml
            git show ${{ github.sha }}:"$file" > after.yaml
            
            # dyff 출력 디버깅
            echo "--- dyff raw output ---"
            dyff between before.yaml after.yaml --omit-header || true
            echo "--- end raw output ---"
            
            # 여러 포맷 시도 (버전별 대응)
            # 방법 1: --output raw
            dyff between before.yaml after.yaml --omit-header --output raw > dyff_output.txt 2>/dev/null || true
            
            # 방법 2: 기본 출력에서 파싱
            if [ ! -s dyff_output.txt ]; then
              echo "Trying default output format..."
              dyff between before.yaml after.after --omit-header > dyff_output.txt 2>/dev/null || true
            fi
            
            # 변경된 경로 추출 (다양한 포맷 대응)
            cat dyff_output.txt | \
              grep -E '^\s*([\+\-\±]|removed|added|modified)' | \
              sed -E 's/^[[:space:]]*(\+|-|±|removed|added|modified)[[:space:]]+//' | \
              sed -E 's/^([^[:space:]]+).*/\1/' | \
              grep -v '^$' > changed_paths.txt || touch changed_paths.txt
            
            echo "--- Extracted paths ---"
            cat changed_paths.txt
            echo "--- End paths ---"
            
            # 경로가 없으면 변경사항 없음으로 처리
            if [ ! -s changed_paths.txt ]; then
              echo "⚠️  No changes detected or unable to parse dyff output for $file"
              continue
            fi
            
            # config 또는 secrets로 시작하는지 확인
            ONLY_ALLOWED=$(grep -E '^(config|secrets)(\.|\[|$)' changed_paths.txt || true)
            DISALLOWED=$(grep -vE '^(config|secrets)(\.|\[|$)' changed_paths.txt || true)
            
            echo "Allowed changes (config/secrets):"
            echo "$ONLY_ALLOWED"
            echo ""
            echo "Disallowed changes (other fields):"
            echo "$DISALLOWED"
            
            # 둘 다 있으면 에러
            if [[ -n "$ONLY_ALLOWED" && -n "$DISALLOWED" ]]; then
              echo "❌ ERROR: $file has BOTH secret/config changes AND other rollout changes."
              echo "You cannot mix configuration updates with deployment updates."
              FAILED=1
            elif [[ -n "$DISALLOWED" && -z "$ONLY_ALLOWED" ]]; then
              echo "✅ Only deployment changes detected (no config/secrets)."
            elif [[ -n "$ONLY_ALLOWED" && -z "$DISALLOWED" ]]; then
              echo "✅ Only config/secrets changes detected."
            else
              echo "⚠️  Unable to determine change type."
            fi
          done

          if [[ "$FAILED" -eq 1 ]]; then
            echo ""
            echo "=========================================="
            echo "❌ Validation failed."
            echo "=========================================="
            exit 1
          fi

          echo ""
          echo "=========================================="
          echo "✅ All validations passed."
          echo "=========================================="
